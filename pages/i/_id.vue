<template>
  <v-container class="pa-0">
    <v-snackbar v-model="showSnackbar" :timeout="2500" color="success" bottom>
      <v-icon>mdi-content-copy</v-icon>
      Successfully copied to clipboard!
    </v-snackbar>
    <v-dialog
      hide-overlay
      persistent
      no-click-animation
      :value="showDialog"
      max-width="400px"
      class="my-md-12 mx-auto"
      transition="none"
      :fullscreen="$vuetify.breakpoint.xsOnly"
    >
      <v-card :loading="loading && !errorText" class="elevation-24">
        <div v-if="loading" :class="$route.query.modal ? 'pb-6' : 'py-6'">
          <close-button @closedialog="closeDialog" />
          <div v-if="errorText" class="text-center">
            {{ errorText ? errorText : "Loading..." }}
          </div>
        </div>
        <div v-else>
          <TabbedCheckout
            v-if="status === 'Pending' || status === 'active'"
            :checkout-page="true"
            :tabitem="invoice.payments"
            :invoice="invoice"
            :store="store"
            class="px-0 pb-0"
            @closedialog="closeDialog"
          />
          <div v-else>
            <close-button @closedialog="closeDialog" />
            <div
              :class="colorClass(texts[status].icon)"
              class="d-flex justify-center success-circle success-icon"
            >
              <v-icon
                :color="texts[status].icon === 'mdi-check' ? 'green' : 'red'"
                class="d-flex justify-center"
              >
                {{ texts[status].icon }}
              </v-icon>
            </div>
            <div class="d-flex justify-center">
              {{ texts[status].text }}
            </div>
          </div>
        </div>
      </v-card>
    </v-dialog>
  </v-container>
</template>

<script>
import TabbedCheckout from "@/components/TabbedCheckout"
import CloseButton from "@/components/CloseButton"
export default {
  auth: false,
  components: {
    TabbedCheckout,
    CloseButton,
  },
  layout: "checkout",
  data() {
    return {
      showSnackbar: false,
      showDialog: true,
      status: "Pending",
      invoice: {},
      store: {},
      loading: true,
      errorText: "",
      texts: {
        expired: {
          icon: "mdi-close",
          text: "This invoice has expired",
        },
        complete: {
          icon: "mdi-check",
          text: "This invoice has been paid",
        },
        Failed: {
          icon: "mdi-close",
          text: "This invoice has failed",
        },
        Invalid: {
          icon: "mdi-close",
          text: "This invoice is invalid",
        },
        "": {
          icon: "mdi-close",
          text: "This invoice is invalid",
        },
      },
    }
  },
  beforeCreate() {
    this.$vuetify.theme.dark = false // dark theme unsupported here
  },
  mounted() {
    this.$axios
      .get(`/invoices/${this.$route.params.id}`)
      .then((resp) => {
        this.invoice = resp.data
        this.status = resp.data.status
        this.loading = false
        window.parent.postMessage("loaded", "*")
        this.$axios
          .get(`/stores/${resp.data.store_id}`)
          .then((resp1) => {
            this.store = resp1.data
            this.loading = false
            this.startWebsocket()
          })
          .catch((err) => (this.errorText = err))
      })
      .catch((err) => this.setError(err))
  },
  methods: {
    setError(err) {
      if (err.response && err.response.status === 404) {
        this.errorText = "Invoice not found"
      } else {
        this.errorText = err
      }
    },
    closeDialog() {
      this.showDialog = false
      window.parent.postMessage("close", "*") // for iframes
    },
    startWebsocket() {
      let url = this.combineURLs(
        `${this.$store.getters.apiURL}`,
        `/ws/invoices/${this.$route.params.id}`
      )
      url = url.replace("http://", "ws://").replace("https://", "wss://")
      const websocket = new WebSocket(url)
      websocket.onmessage = (event) => {
        const status = JSON.parse(event.data).status
        if (this.invoice.status !== status) {
          window.parent.postMessage(
            { invoice_id: this.invoice.id, status },
            "*"
          )
        }
        if (status === "complete" && this.invoice.redirect_url) {
          this.$utils.redirectTo(this.invoice.redirect_url)
        }
        this.status = status
      }
    },
    colorClass(icon) {
      return {
        "green-color": icon === "mdi-check",
        "red-color": icon !== "mdi-check",
      }
    },
    copyText(text) {
      this.$utils.copyToClipboard(text)
      this.whatToCopy = "ID"
      this.showSnackbar = true
    },
    combineURLs(baseURL, relativeURL) {
      return relativeURL
        ? baseURL.replace(/\/+$/, "") + "/" + relativeURL.replace(/^\/+/, "")
        : baseURL
    },
  },
}
</script>

<style scoped>
@keyframes checkbounce {
  0% {
    transform: matrix3d(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  4.7% {
    transform: matrix3d(0.45, 0, 0, 0, 0, 0.45, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  9.41% {
    transform: matrix3d(0.883, 0, 0, 0, 0, 0.883, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  14.11% {
    transform: matrix3d(1.141, 0, 0, 0, 0, 1.141, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  18.72% {
    transform: matrix3d(1.212, 0, 0, 0, 0, 1.212, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  24.32% {
    transform: matrix3d(1.151, 0, 0, 0, 0, 1.151, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  29.93% {
    transform: matrix3d(1.048, 0, 0, 0, 0, 1.048, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  35.54% {
    transform: matrix3d(0.979, 0, 0, 0, 0, 0.979, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  41.04% {
    transform: matrix3d(0.961, 0, 0, 0, 0, 0.961, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  52.15% {
    transform: matrix3d(0.991, 0, 0, 0, 0, 0.991, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  63.26% {
    transform: matrix3d(1.007, 0, 0, 0, 0, 1.007, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  85.49% {
    transform: matrix3d(0.999, 0, 0, 0, 0, 0.999, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }

  100% {
    transform: matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
  }
}
.success-circle {
  border-radius: 50%;
  height: 154px;
  width: 154px;
  margin: 0 auto;
  border-width: 2px;
  border-style: solid;
}
.green-color {
  border-color: #13e5b6;
}
.red-color {
  border-color: red;
}
.success-icon {
  animation: checkbounce 750ms linear both;
}
</style>
