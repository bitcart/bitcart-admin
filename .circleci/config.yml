version: 2.1
executors:
  deploy-machine:
    machine:
      enabled: true
      image: ubuntu-2004:202101-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled

jobs:
  test:
    docker:
      - image: circleci/node:14

    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "package.json" }}-{{ .Branch }}
            - v2-dependencies-

      - run: yarn install

      - save_cache:
          paths:
            - node_modules
          key: v2-dependencies-{{ checksum "package.json" }}-{{ .Branch }}

      - run: yarn lint

  deploy:
    executor: deploy-machine

    environment:
      BUILD_PLATFORMS: linux/amd64,linux/arm/v7,linux/arm64/v8

    steps:
      - checkout
      - run: |
          docker login -u $DOCKER_USER -p $DOCKER_PASS
          docker run --privileged --rm tonistiigi/binfmt --install ${BUILD_PLATFORMS}
          docker buildx create --name builder --use
          docker buildx build --progress plain --push --platform ${BUILD_PLATFORMS} --tag mrnaif/test-admin:test --tag mrnaif/test-admin:stable .

workflows:
  version: 2
  test-and-deploy:
    jobs:
      - deploy:
          context: global
