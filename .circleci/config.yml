version: 2.1

executors:
  build-ubuntu:
    machine:
      enabled: true
      image: ubuntu-2004:202101-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled
    resource_class: medium

  build-ubuntu-arm:
    machine:
      enabled: true
      image: ubuntu-2004:202101-01
    environment:
      DOCKER_CLI_EXPERIMENTAL: enabled
    resource_class: arm.medium

commands:
  login-to-dockerhub:
    steps:
      - run:
          name: Login to dockerhub
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS

  enable-buildx:
    steps:
      - run:
          name: Enable Docker Buildx
          command: |
            sudo apt update
            sudo apt install qemu qemu-user-static binfmt-support debootstrap -y
            docker buildx create --name builder --use

jobs:
  test:
    docker:
      - image: circleci/node:14

    working_directory: ~/repo

    steps:
      - checkout

      - restore_cache:
          keys:
            - v2-dependencies-{{ checksum "package.json" }}-{{ .Branch }}
            - v2-dependencies-

      - run: yarn install

      - save_cache:
          paths:
            - node_modules
          key: v2-dependencies-{{ checksum "package.json" }}-{{ .Branch }}

      - run: yarn lint

  deploy-amd64:
    executor: build-ubuntu

    environment:
      BUILD_PLATFORMS: linux/amd64

    steps:
      - checkout
      - login-to-dockerhub
      - enable-buildx
      - run:
          name: Build AMD64 image
          command: |
            docker buildx build --progress plain --pull --push --platform ${BUILD_PLATFORMS} --tag mrnaif/test-admin7:test --tag mrnaif/test-admin7:stable .

  deploy-arm:
    executor: build-ubuntu-arm

    environment:
      BUILD_PLATFORMS: linux/arm/v7,linux/arm64/v8

    steps:
      - checkout
      - login-to-dockerhub
      - enable-buildx
      - run:
          name: Build ARM images
          command: |
            docker buildx build --progress plain --pull --push --platform ${BUILD_PLATFORMS} --tag mrnaif/test-admin7:test --tag mrnaif/test-admin7:stable .

workflows:
  version: 2
  test-and-deploy:
    jobs:
      - deploy-amd64:
          context: global
      - deploy-arm:
          context: global
